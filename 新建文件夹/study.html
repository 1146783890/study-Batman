<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å­¦ä¹ ç³»ç»Ÿ</title>
<head>
    <meta charset="UTF-8">
    <!-- æ ¸å¿ƒï¼šé€‚é…æ‰‹æœºå±å¹•ï¼ˆä½ åŸæœ‰ä»£ç å·²åŒ…å«ï¼Œä¿ç•™å³å¯ï¼‰ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- ç½‘é¡µæ ‡é¢˜ï¼ˆæ˜¾ç¤ºåœ¨æµè§ˆå™¨æ ‡ç­¾/APPå›¾æ ‡ä¸‹æ–¹ï¼‰ -->
    <title>å­¦ä¹ æ—¥ç¨‹ç®¡ç†</title>
    
    <!-- 1. æ·»åŠ APPå›¾æ ‡ï¼ˆå…³é”®ï¼šæ›¿æ¢icon.pngä¸ºä½ çš„å›¾æ ‡è·¯å¾„ï¼‰ -->
    <!-- é€šç”¨å›¾æ ‡ï¼ˆAndroid/æµè§ˆå™¨ï¼‰ -->
    <link rel="icon" href="icon.png" sizes="192x192">
    <!-- iOSä¸“ç”¨å›¾æ ‡ï¼ˆæ·»åŠ åˆ°ä¸»å±å¹•æ—¶æ˜¾ç¤ºï¼‰ -->
        <!-- å¼€å¯å…¨å±æ¨¡å¼ï¼ˆæ— æµè§ˆå™¨åœ°å€æ ï¼‰ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <!-- çŠ¶æ€æ æ ·å¼ï¼ˆblack=é»‘è‰²èƒŒæ™¯ï¼Œwhite=ç™½è‰²ï¼‰ -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <!-- iOSä¸»å±å¹•APPåç§°ï¼ˆå¯è‡ªå®šä¹‰ï¼Œæ¯”å¦‚â€œå­¦ä¹ ç³»ç»Ÿâ€ï¼‰ -->
    <meta name="apple-mobile-web-app-title" content="å­¦ä¹ ç³»ç»Ÿ">
</head>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto}
:root{--bg:#f7f8fa;--card:#fff;--text:#222;--text2:#666;--border:#eee;--main:#4285f4;--done:#73d673;--del:#ff4d4f;--gray:#999;--lightgray:#eee;--overdue:#ff4d4f}
.dark{--bg:#121212;--card:#1e1e1e;--text:#f0f0f0;--text2:#aaa;--border:#333;--gray:#666;--lightgray:#444;--overdue:#ff6b6b}
body{background:var(--bg);color:var(--text);max-width:900px;margin:0 auto;padding:16px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.title{font-size:20px;font-weight:600}
.btn-theme{padding:6px 12px;border-radius:20px;border:1px solid var(--border);background:var(--card);color:var(--text);cursor:pointer}
.tabs{display:grid;grid-template-columns:repeat(8,1fr);gap:4px;margin-bottom:14px}
.tab{padding:8px 2px;text-align:center;background:var(--card);border-radius:8px;font-size:13px;cursor:pointer}
.tab.active{background:var(--main);color:#fff}
.page{display:none}
.page.show{display:block}
.card{background:var(--card);border-radius:12px;padding:14px;margin-bottom:12px}
input,button,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--text);margin-bottom:8px}
textarea{min-height:80px}
button{background:var(--main);color:#fff;font-weight:500;cursor:pointer}
.flex{display:flex;gap:8px}
.flex>*{flex:1}
.item{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)}
.item-left{display:flex;align-items:center;flex:1}
.item input[type=checkbox]{width:18px;height:18px;margin-right:8px}
.item-text{flex:1}
.item-text.done{text-decoration:line-through;color:var(--text2)}
.item-text.overdue{color:var(--overdue);font-weight:500}
.item-del{color:var(--del);font-size:14px;cursor:pointer;width:auto;white-space:nowrap;margin-left:8px}
/* æ—¥å†ç½‘æ ¼ */
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:10px}
.cal-day{background:var(--card);border-radius:8px;padding:8px;font-size:14px;min-height:120px;position:relative;transition:0.1s}
.cal-title{font-weight:bold;margin-bottom:6px;padding-bottom:4px;border-bottom:1px solid var(--lightgray);display:flex;justify-content:space-between;align-items:center;cursor:pointer;user-select:none;}
.cal-title:hover{opacity:0.8}
.cal-streak{font-size:11px;color:var(--main);background:rgba(66,133,244,0.1);padding:2px 6px;border-radius:4px;margin-left:4px;}
/* æ—¥å†é¡¹åŸºç¡€æ ·å¼ */
.cal-item{font-size:13px;padding:2px 0;margin-bottom:4px;display:flex;align-items:center;width:100%;}
.cal-item input[type=checkbox]{width:16px;height:16px;margin-right:6px;}
.cal-item .done{text-decoration:line-through;color:var(--text2)}
/* æŠ˜å æ§åˆ¶ï¼šåªé’ˆå¯¹å¯æŠ˜å ç±»åˆ«ï¼ˆç”Ÿæ´»ã€å­¦ä¹ ï¼‰æ·»åŠ æŠ˜å åŠŸèƒ½ */
.cal-day.collapsed .cal-item.foldable{display:none;}
/* è¿åŠ¨ã€å¤ä¹ è®¡åˆ’å§‹ç»ˆæ˜¾ç¤ºï¼ˆä¸å—æŠ˜å å½±å“ï¼‰*/
.cal-item.always-show{display:flex !important;}
/* æ—¥æœŸå³ä¸Šè§’å°æŠ˜å å›¾æ ‡ */
.cal-toggle-indicator{font-size:12px;color:var(--gray);margin-left:5px;}
/* å…¨å±€æ”¶èµ·æŒ‰é’® */
.calendar-header-extra{display:flex;justify-content:flex-end;margin-bottom:8px;gap:6px;}
.cal-collapse-btn{width:auto;padding:6px 12px;background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:20px;font-size:13px;cursor:pointer;}
.cal-collapse-btn:hover{background:var(--lightgray);}
/* å¹´æœˆé€‰æ‹©å™¨ */
.cal-select{display:flex;align-items:center;gap:8px;margin-bottom:12px}
.cal-select select{margin:0;padding:6px 8px;height:36px;}
.cal-select button{margin:0;padding:6px 12px;height:36px;}
/* æˆå°±å¾½ç« ç­‰ä¿ç•™åŸæœ‰æ ·å¼ */
.badge-box{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.badge{padding:6px 8px;border-radius:8px;font-size:14px;background:var(--main);color:#fff}
.badge.locked{background:#ccc;color:#666}
.upload-area{border:2px dashed var(--border);padding:20px;text-align:center;border-radius:12px;margin:10px 0}
.ebb-btn-group{display:flex;gap:4px;}
.ebb-btn{width:auto;padding:4px 8px;font-size:12px;margin:0;border-radius:4px;}
.ebb-del-btn{background:var(--del);}
.repeat-check{width:auto;height:18px;margin:0 6px 0 0;}
.repeat-label{font-size:14px;color:var(--text2);align-self:center;}
.timer-box{text-align:center;margin:16px 0;}
.timer-display{font-size:40px;font-weight:700;margin:12px 0;letter-spacing:2px;}
.timer-btns{display:flex;gap:10px;justify-content:center;margin:8px 0;}
.timer-btns button{width:auto;padding:8px 20px;}
.timer-reset{background:var(--del);}
.tomato-box{text-align:center;margin:16px 0;}
.tomato-display{font-size:40px;font-weight:700;margin:12px 0;letter-spacing:2px;}
.tomato-status{font-size:16px;color:var(--main);margin-bottom:8px;}
.tomato-btns{display:flex;gap:10px;justify-content:center;margin:8px 0;}
.tomato-cycle{margin-top:10px;display:flex;align-items:center;justify-content:center;gap:8px;}
.time-stat{margin-top:12px;padding-top:12px;border-top:1px solid var(--border);}
.stat-item{display:flex;justify-content:space-between;padding:4px 0;font-size:14px;}
.point-box{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);margin-bottom:12px;}
.point-display{font-size:24px;font-weight:700;color:var(--main);}
.share-box{margin-top:12px;}
.share-preview{margin-top:12px;border:1px solid var(--border);border-radius:8px;padding:10px;background:var(--card);min-height:200px;}
.setting-item{display:flex;align-items:center;gap:8px;margin-bottom:12px;}
.setting-item label{flex:1;font-size:14px;}
.setting-item input,.setting-item select{flex:2;margin:0;padding:8px;}
.streak-box{margin-top:12px;padding:10px;border-radius:8px;background:rgba(66,133,244,0.1);}
.streak-title{font-size:16px;font-weight:600;margin-bottom:8px;color:var(--main);}
</style>
</head>
<body>
<div class="header">
  <div class="title">å­¦ä¹ ç³»ç»Ÿ</div>
  <button class="btn-theme" onclick="toggleTheme()">æ·±è‰²æ¨¡å¼</button>
</div>
<div class="tabs">
  <div class="tab active" data-page="life">ç”Ÿæ´»å¾…åŠ</div>
  <div class="tab" data-page="study">å­¦ä¹ æ—¥ç¨‹</div>
  <div class="tab" data-page="sport">è¿åŠ¨æ‰“å¡</div>
  <div class="tab" data-page="ebb">å¤ä¹ è®¡åˆ’</div>
  <div class="tab" data-page="calendar">æ—¥å†æ€»è§ˆ</div>
  <div class="tab" data-page="badge">æˆå°±ç§¯åˆ†</div>
  <div class="tab" data-page="tool">å·¥å…·</div>
  <div class="tab" data-page="settings">è®¾ç½®</div>
</div>

<!-- ç”Ÿæ´»å¾…åŠï¼šå¼€å§‹æ—¥æœŸ + æˆªæ­¢æ—¶é—´ -->
<div class="page show" id="life">
  <div class="card">
    <textarea id="lifeMulti" placeholder="å¤šè¡Œè¾“å…¥ï¼Œè‡ªåŠ¨ç”Ÿæˆç”Ÿæ´»å¾…åŠ"></textarea>
    <div class="flex">
      <input type="date" id="lifeStartDate" placeholder="å¼€å§‹æ—¥æœŸ" value="">
      <input type="datetime-local" id="lifeDeadline" placeholder="æˆªæ­¢æ—¶é—´" value="">
    </div>
    <label class="repeat-label"><input type="checkbox" class="repeat-check" id="lifeRepeat"> æ¯å¤©é‡å¤</label>
    <button onclick="addLifeMulti()">âœ… ä¸€é”®ç”Ÿæˆ</button>
  </div>
  <div class="card" id="lifeList"></div>
</div>

<!-- å­¦ä¹ æ—¥ç¨‹ï¼šå¼€å§‹æ—¥æœŸ + æˆªæ­¢æ—¶é—´ -->
<div class="page" id="study">
  <div class="card">
    <textarea id="studyMulti" placeholder="ç²˜è´´è®¡åˆ’ï¼Œä¸€é”®å¯¼å…¥å­¦ä¹ ä»»åŠ¡"></textarea>
    <div class="flex">
      <input type="date" id="studyStartDate" placeholder="å¼€å§‹æ—¥æœŸ" value="">
      <input type="datetime-local" id="studyDeadline" placeholder="æˆªæ­¢æ—¶é—´" value="">
    </div>
    <label class="repeat-label"><input type="checkbox" class="repeat-check" id="studyRepeat"> æ¯å¤©é‡å¤</label>
    <button onclick="addStudyMulti()">âœ… ä¸€é”®å¯¼å…¥</button>
    <div class="time-stat">
      <h4>ğŸ“Š å­¦ä¹ æ—¶é•¿ç»Ÿè®¡</h4>
      <div class="stat-item"><span>ä»Šæ—¥å­¦ä¹ æ—¶é•¿</span><span id="todayStudyTime">00:00:00</span></div>
      <div class="stat-item"><span>æœ¬å‘¨å­¦ä¹ æ—¶é•¿</span><span id="weekStudyTime">00:00:00</span></div>
      <div class="stat-item"><span>ç´¯è®¡å­¦ä¹ æ—¶é•¿</span><span id="totalStudyTime">00:00:00</span></div>
    </div>
  </div>
  <div class="card" id="studyList"></div>
</div>

<!-- è¿åŠ¨æ‰“å¡ -->
<div class="page" id="sport">
  <div class="card">
    <div class="flex">
      <select id="sportType"><option>è·‘æ­¥</option><option>è·³ç»³</option><option>æ‹‰ä¼¸</option><option>ä¿¯å§æ’‘</option><option>ä»°å§èµ·å</option><option>ç¯®çƒ</option></select>
      <input id="sportNum" placeholder="æ¬¡æ•°/åˆ†é’Ÿ" type="number">
    </div>
    <div class="flex">
      <input type="date" id="sportDate" value="">
      <label class="repeat-label"><input type="checkbox" class="repeat-check" id="sportRepeat"> æ¯å¤©é‡å¤</label>
    </div>
    <button onclick="addSport()">ğŸƒ æ‰“å¡è¿åŠ¨</button>
    <div class="streak-box">
      <div class="streak-title">ğŸ† è¿ç»­æ‰“å¡ç»Ÿè®¡</div>
      <div class="streak-item"><span>è¿ç»­å­¦ä¹ æ‰“å¡</span><span id="studyStreak">0 å¤©</span></div>
      <div class="streak-item"><span>è¿ç»­è¿åŠ¨æ‰“å¡</span><span id="sportStreak">0 å¤©</span></div>
    </div>
  </div>
  <div class="card" id="sportList"></div>
</div>

<!-- å¤ä¹ è®¡åˆ’ -->
<div class="page" id="ebb">
  <div class="card">
    <input id="ebbSubject" placeholder="ç§‘ç›®ï¼šè‹±è¯­ä¸€/è‹±è¯­äºŒ/æ”¿æ²»/ä¸“ä¸šè¯¾">
    <input type="date" id="ebbDate">
    <button onclick="createMultiEbb()">ğŸ“… ç”Ÿæˆè¯¥ç§‘ç›®å¤ä¹ è®¡åˆ’</button>
  </div>
  <div class="card" id="ebbBox"></div>
</div>

<!-- æ—¥å†æ€»è§ˆï¼ˆç”Ÿæ´»/å­¦ä¹ å¯æŠ˜å ï¼Œè¿åŠ¨/å¤ä¹ å§‹ç»ˆæ˜¾ç¤ºï¼‰ -->
<div class="page" id="calendar">
  <div class="card">
    <div class="flex" style="justify-content: space-between; align-items: center; margin-bottom: 10px;">
      <h3 style="margin:0;">ğŸ—“ï¸ æ—¥å†</h3>
      <div class="calendar-header-extra">
        <button class="cal-collapse-btn" id="collapseAllBtn" onclick="toggleAllCollapse()">å…¨éƒ¨æ”¶èµ·</button>
      </div>
    </div>
    <div class="cal-select">
      <select id="calYear"></select>
      <select id="calMonth"></select>
      <button onclick="renderCalendarBySelect()">æŸ¥è¯¢</button>
      <button onclick="renderCalendarToday()">å›åˆ°ä»Šæ—¥</button>
    </div>
    <div class="calendar" id="calendarBox"></div>
  </div>
</div>

<!-- æˆå°±ç§¯åˆ†ç³»ç»Ÿ -->
<div class="page" id="badge">
  <div class="card">
    <h3>ğŸ… æˆ‘çš„æˆå°±</h3>
    <div class="point-box"><div><div>å½“å‰ç§¯åˆ†</div><div class="point-display" id="totalPoints">0</div></div><div><div>ç§¯åˆ†è§„åˆ™</div><div class="point-detail">å®Œæˆå¾…åŠ+5 | è¿åŠ¨æ‰“å¡+10 | å­¦ä¹ 1å°æ—¶+20 | è¿ç»­æ‰“å¡+50</div></div></div>
    <div class="badge-box" id="badgeBox"></div>
    <div class="share-box"><h4>ğŸ“¤ æ•°æ®åˆ†äº«</h4><button class="share-btn" onclick="generateShareImage('today')">ç”Ÿæˆä»Šæ—¥æ•°æ®å›¾</button><button class="share-btn" onclick="generateShareImage('week')">ç”Ÿæˆæœ¬å‘¨æ•°æ®å›¾</button><button class="share-btn" onclick="copyShareImage()">å¤åˆ¶å›¾ç‰‡</button><button class="share-btn" onclick="saveShareImage()">ä¿å­˜å›¾ç‰‡</button><div class="share-preview" id="sharePreview"></div></div>
  </div>
</div>

<!-- å·¥å…· -->
<div class="page" id="tool">
  <div class="card"><h3>â±ï¸ ä¸“æ³¨è®¡æ—¶</h3><div class="timer-box"><div class="timer-display" id="timerDisplay">00:00:00</div><div class="timer-btns"><button onclick="startTimer()">å¼€å§‹</button><button onclick="pauseTimer()">æš‚åœ</button><button class="timer-reset" onclick="resetTimer()">é‡ç½®</button></div><div class="timer-task"><input type="text" id="timerTask" placeholder="è¾“å…¥å½“å‰ä¸“æ³¨ä»»åŠ¡"><button onclick="saveTimerRecord()">ä¿å­˜è®¡æ—¶è®°å½•</button></div></div></div>
  <div class="card"><h3>ğŸ… ç•ªèŒ„é’Ÿ</h3><div class="tomato-box"><div class="tomato-status" id="tomatoStatus">å‡†å¤‡ä¸­ï¼šå­¦ä¹ æ¨¡å¼</div><div class="tomato-display" id="tomatoDisplay">50:00</div><div class="tomato-cycle"><span>å¾ªç¯æ¬¡æ•°ï¼š</span><input type="number" id="tomatoCycle" min="1" max="10" value="1"><span>æ¬¡</span><label><input type="checkbox" id="tomatoAutoCycle" checked> è‡ªåŠ¨å¾ªç¯</label></div><div class="tomato-btns"><button onclick="startTomato()">å¼€å§‹ç•ªèŒ„é’Ÿ</button><button onclick="pauseTomato()">æš‚åœ</button><button class="timer-reset" onclick="resetTomato()">é‡ç½®</button></div></div></div>
  <div class="card"><h3>ğŸ’¾ æ•°æ®å¤‡ä»½ä¸æ¢å¤</h3><button onclick="backupData()">å¤‡ä»½æ•°æ®</button><button onclick="restoreData()">æ¢å¤æ•°æ®</button></div>
  <div class="card"><h3>ğŸ“ æ–‡æ¡£ä¸Šä¼ </h3><div class="upload-area" id="dropArea">å°†æ–‡æ¡£æ‹–æ‹½åˆ°æ­¤å¤„ä¸Šä¼ </div></div>
  <div class="card"><button onclick="exportExcel()">å¯¼å‡ºè¡¨æ ¼</button><button onclick="clearAll()">æ¸…ç©ºæ•°æ®</button></div>
</div>

<!-- è®¾ç½®é¡µé¢ -->
<div class="page" id="settings">
  <div class="card"><h3>âš™ï¸ åŸºç¡€è®¾ç½®</h3><div class="setting-item"><label>ä¸“æ³¨è®¡æ—¶é»˜è®¤æ—¶é•¿(åˆ†é’Ÿ)</label><input type="number" id="settingTimerDefault" min="1" max="120" value="25"></div><div class="setting-item"><label>ç•ªèŒ„é’Ÿå­¦ä¹ æ—¶é•¿(åˆ†é’Ÿ)</label><input type="number" id="settingTomatoStudy" min="5" max="60" value="50"></div><div class="setting-item"><label>ç•ªèŒ„é’Ÿä¼‘æ¯æ—¶é•¿(åˆ†é’Ÿ)</label><input type="number" id="settingTomatoRest" min="1" max="30" value="10"></div><div class="setting-item"><label>æ¯æ—¥å­¦ä¹ ç›®æ ‡(å°æ—¶)</label><input type="number" id="settingStudyGoal" min="0.5" max="12" step="0.5" value="2"></div><div class="setting-item"><label>æé†’æ–¹å¼</label><select id="settingReminder"><option value="alert">æµè§ˆå™¨æç¤º</option><option value="notification">æ¡Œé¢é€šçŸ¥</option></select></div><button onclick="saveSettings()">ä¿å­˜è®¾ç½®</button><button onclick="resetSettings()">æ¢å¤é»˜è®¤</button></div>
  <div class="card"><h3>ğŸ“Š æ•°æ®ç»Ÿè®¡</h3><div class="stat-item"><span>æ€»ç§¯åˆ†</span><span id="settingsTotalPoints">0</span></div><div class="stat-item"><span>å·²å®Œæˆä»»åŠ¡æ•°</span><span id="settingsCompletedTasks">0</span></div><div class="stat-item"><span>æœ€é•¿è¿ç»­å­¦ä¹ å¤©æ•°</span><span id="settingsMaxStudyStreak">0</span></div><div class="stat-item"><span>æœ€é•¿è¿ç»­è¿åŠ¨å¤©æ•°</span><span id="settingsMaxSportStreak">0</span></div></div>
</div>

<script>
// ================== å…¨å±€å˜é‡ ==================
const STORAGE_KEYS = {
  LIFE: 'life', STUDY: 'study', SPORT: 'sport', MEBB: 'mebb',
  STUDY_TIME: 'studyTimeRecord', POINTS: 'pointsRecord',
  SETTINGS: 'appSettings', STREAK: 'streakRecord', THEME: 'theme',
  CAL_DONE: 'calendarDone', CAL_FOLD: 'calendarFold'
};

let state = {
  currentCalYear: new Date().getFullYear(),
  currentCalMonth: new Date().getMonth(),
  timer: { interval: null, seconds: 0, running: false },
  tomato: { interval: null, seconds: 0, running: false, isStudy: true, currentCycle: 0, totalCycle: 1 },
  data: {
    studyTime: JSON.parse(localStorage.getItem(STORAGE_KEYS.STUDY_TIME) || '[]'),
    points: JSON.parse(localStorage.getItem(STORAGE_KEYS.POINTS) || '[]'),
    streak: JSON.parse(localStorage.getItem(STORAGE_KEYS.STREAK) || '{"study":[],"sport":[],"maxStudy":0,"maxSport":0}'),
    settings: JSON.parse(localStorage.getItem(STORAGE_KEYS.SETTINGS) || '{"timerDefault":25,"tomatoStudy":50,"tomatoRest":10,"studyGoal":2,"reminder":"alert"}'),
    calDone: JSON.parse(localStorage.getItem(STORAGE_KEYS.CAL_DONE) || '{}'),
    calFold: JSON.parse(localStorage.getItem(STORAGE_KEYS.CAL_FOLD) || '{}')
  }
};

const storage = {
  get: (key) => JSON.parse(localStorage.getItem(key) || '[]'),
  set: (key, data) => localStorage.setItem(key, JSON.stringify(data)),
  getToday: () => new Date().toISOString().split('T')[0],
  formatTime: (seconds) => {
    const h = Math.floor(seconds / 3600).toString().padStart(2,'0');
    const m = Math.floor((seconds % 3600)/60).toString().padStart(2,'0');
    const s = (seconds % 60).toString().padStart(2,'0');
    return `${h}:${m}:${s}`;
  },
  formatDate: (date) => typeof date === 'string' ? date : date.toISOString().split('T')[0]
};

// ================== åˆå§‹åŒ– ==================
function initApp() {
  if (localStorage.getItem(STORAGE_KEYS.THEME) === 'dark') document.body.classList.add('dark');
  initTabSwitch();
  renderLife(); renderStudy(); renderSport(); renderMultiEbb(); updateSettingsStats(); resetTomato();
  initCalSelect(); renderCalendar(state.currentCalYear, state.currentCalMonth);
}

function initTabSwitch() {
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.page').forEach(p => p.classList.remove('show'));
      tab.classList.add('active');
      const pageId = tab.dataset.page;
      document.getElementById(pageId).classList.add('show');
      if (pageId === 'calendar') { initCalSelect(); renderCalendar(state.currentCalYear, state.currentCalMonth); }
      if (pageId === 'study') calculateStudyTime();
      if (pageId === 'badge') { updateSettingsStats(); checkBadge(); }
      if (pageId === 'settings') initSettings();
    });
  });
}

function toggleTheme() {
  document.body.classList.toggle('dark');
  localStorage.setItem(STORAGE_KEYS.THEME, document.body.classList.contains('dark') ? 'dark' : 'light');
}

// ================== è®¾ç½® ==================
function initSettings() {
  const s = state.data.settings;
  document.getElementById('settingTimerDefault').value = s.timerDefault;
  document.getElementById('settingTomatoStudy').value = s.tomatoStudy;
  document.getElementById('settingTomatoRest').value = s.tomatoRest;
  document.getElementById('settingStudyGoal').value = s.studyGoal;
  document.getElementById('settingReminder').value = s.reminder;
  updateSettingsStats();
}
function saveSettings() {
  state.data.settings = {
    timerDefault: parseInt(document.getElementById('settingTimerDefault').value),
    tomatoStudy: parseInt(document.getElementById('settingTomatoStudy').value),
    tomatoRest: parseInt(document.getElementById('settingTomatoRest').value),
    studyGoal: parseFloat(document.getElementById('settingStudyGoal').value),
    reminder: document.getElementById('settingReminder').value
  };
  storage.set(STORAGE_KEYS.SETTINGS, state.data.settings);
  resetTomato();
  alert('è®¾ç½®ä¿å­˜æˆåŠŸï¼');
  updateSettingsStats();
}
function resetSettings() {
  state.data.settings = { timerDefault:25, tomatoStudy:50, tomatoRest:10, studyGoal:2, reminder:'alert' };
  storage.set(STORAGE_KEYS.SETTINGS, state.data.settings);
  initSettings(); resetTomato(); alert('å·²æ¢å¤é»˜è®¤è®¾ç½®ï¼');
}

// ================== ç§¯åˆ†/æ‰“å¡ ==================
function addPoints(type, points) {
  state.data.points.push({ type, points, date: storage.getToday(), time: new Date().toLocaleString() });
  storage.set(STORAGE_KEYS.POINTS, state.data.points);
  updateSettingsStats();
}
function recordStreak(type) {
  const today = storage.getToday();
  if (!state.data.streak[type]) state.data.streak[type] = [];
  if (!state.data.streak[type].includes(today)) {
    state.data.streak[type].push(today);
    state.data.streak[type].sort();
    let maxStreak = 1, cur = 1;
    for (let i=1; i<state.data.streak[type].length; i++) {
      const prev = new Date(state.data.streak[type][i-1]);
      const curr = new Date(state.data.streak[type][i]);
      if ((curr - prev) / (86400000) === 1) { cur++; maxStreak = Math.max(maxStreak, cur); }
      else cur = 1;
    }
    state.data.streak[`max${type.charAt(0).toUpperCase()+type.slice(1)}`] = maxStreak;
    storage.set(STORAGE_KEYS.STREAK, state.data.streak);
    const curStreak = calculateCurrentStreak(type);
    if (curStreak % 7 === 0 && curStreak > 0) addPoints(`è¿ç»­${type}æ‰“å¡${curStreak}å¤©`, 50);
  }
  updateSettingsStats();
}
function calculateCurrentStreak(type) {
  const arr = state.data.streak[type] || [];
  if (!arr.length) return 0;
  const sorted = [...arr].sort((a,b)=>new Date(b)-new Date(a));
  let streak = 0, today = new Date();
  for (let i=0; i<sorted.length; i++) {
    const d = new Date(sorted[i]);
    const diff = Math.floor((today - d) / 86400000);
    if (diff === streak) streak++;
    else break;
  }
  return streak;
}
function isOverdue(deadline) {
  return deadline ? new Date() > new Date(deadline) : false;
}
function updateSettingsStats() {
  const total = state.data.points.reduce((s,i)=>s+i.points,0);
  document.getElementById('totalPoints') && (document.getElementById('totalPoints').textContent = total);
  document.getElementById('settingsTotalPoints') && (document.getElementById('settingsTotalPoints').textContent = total);
  const lifeDone = storage.get(STORAGE_KEYS.LIFE).filter(i=>i.done).length;
  const studyDone = storage.get(STORAGE_KEYS.STUDY).filter(i=>i.done).length;
  document.getElementById('settingsCompletedTasks') && (document.getElementById('settingsCompletedTasks').textContent = lifeDone+studyDone);
  document.getElementById('settingsMaxStudyStreak') && (document.getElementById('settingsMaxStudyStreak').textContent = (state.data.streak.maxStudy||0)+'å¤©');
  document.getElementById('settingsMaxSportStreak') && (document.getElementById('settingsMaxSportStreak').textContent = (state.data.streak.maxSport||0)+'å¤©');
  document.getElementById('studyStreak') && (document.getElementById('studyStreak').textContent = calculateCurrentStreak('study')+'å¤©');
  document.getElementById('sportStreak') && (document.getElementById('sportStreak').textContent = calculateCurrentStreak('sport')+'å¤©');
}

// ================== ç”Ÿæ´»å¾…åŠ ==================
function addLifeMulti() {
  const text = document.getElementById('lifeMulti').value.trim();
  const startDate = document.getElementById('lifeStartDate').value || storage.getToday();
  const deadline = document.getElementById('lifeDeadline').value;
  const repeat = document.getElementById('lifeRepeat').checked;
  if (!text) return;
  const lines = text.split('\n').map(l=>l.trim()).filter(l=>l);
  const list = storage.get(STORAGE_KEYS.LIFE);
  lines.forEach(line => {
    if (!list.some(i=>i.text===line && i.startDate===startDate))
      list.push({ startDate, text: line, done: false, repeat, deadline });
  });
  storage.set(STORAGE_KEYS.LIFE, list);
  document.getElementById('lifeMulti').value = '';
  document.getElementById('lifeDeadline').value = '';
  document.getElementById('lifeRepeat').checked = false;
  renderLife();
  if (document.getElementById('calendar').classList.contains('show')) renderCalendar(state.currentCalYear, state.currentCalMonth);
  checkBadge();
}
function renderLife() {
  const list = storage.get(STORAGE_KEYS.LIFE);
  const container = document.getElementById('lifeList');
  container.innerHTML = '';
  list.forEach((item, idx) => {
    const overdue = isOverdue(item.deadline) && !item.done;
    const repeatText = item.repeat ? '[æ¯æ—¥] ' : '';
    const startText = item.startDate ? `å¼€å§‹:${item.startDate} ` : '';
    const deadlineText = item.deadline ? `| æˆªæ­¢:${item.deadline.replace('T',' ')}` : '';
    const div = document.createElement('div'); div.className = 'item';
    div.innerHTML = `<div class="item-left"><input type="checkbox" ${item.done ? 'checked' : ''} onchange="toggleLife(${idx})"><div class="item-text ${item.done?'done':''} ${overdue?'overdue':''}">${repeatText}${startText}${deadlineText} | ${item.text}${overdue?' âš ï¸é€¾æœŸ':''}</div></div><div class="item-del" onclick="delLife(${idx})">åˆ é™¤</div>`;
    container.appendChild(div);
  });
}
function toggleLife(idx) { let l=storage.get(STORAGE_KEYS.LIFE); l[idx].done=!l[idx].done; storage.set(STORAGE_KEYS.LIFE,l); renderLife(); if(document.getElementById('calendar').classList.contains('show')) renderCalendar(state.currentCalYear, state.currentCalMonth); }
function delLife(idx) { let l=storage.get(STORAGE_KEYS.LIFE); l.splice(idx,1); storage.set(STORAGE_KEYS.LIFE,l); renderLife(); if(document.getElementById('calendar').classList.contains('show')) renderCalendar(state.currentCalYear, state.currentCalMonth); }

// ================== å­¦ä¹ æ—¥ç¨‹ ==================
function addStudyMulti() {
  const text = document.getElementById('studyMulti').value.trim();
  const startDate = document.getElementById('studyStartDate').value || storage.getToday();
  const deadline = document.getElementById('studyDeadline').value;
  const repeat = document.getElementById('studyRepeat').checked;
  if (!text) return;
  const lines = text.split('\n').map(l=>l.trim()).filter(l=>l);
  const list = storage.get(STORAGE_KEYS.STUDY);
  lines.forEach(line => {
    const timeMatch = line.match(/(\d{1,2}:\d{2})/)?.[1] || '';
    const content = timeMatch ? line.replace(timeMatch,'').trim() : line;
    if (!list.some(i=>i.content===content && i.startDate===startDate))
      list.push({ startDate, time: timeMatch, content, done: false, repeat, deadline });
  });
  storage.set(STORAGE_KEYS.STUDY, list);
  document.getElementById('studyMulti').value = '';
  document.getElementById('studyDeadline').value = '';
  document.getElementById('studyRepeat').checked = false;
  renderStudy();
  if (document.getElementById('calendar').classList.contains('show')) renderCalendar(state.currentCalYear, state.currentCalMonth);
  checkBadge();
}
function renderStudy() {
  const list = storage.get(STORAGE_KEYS.STUDY);
  const container = document.getElementById('studyList');
  container.innerHTML = '';
  list.forEach((item, idx) => {
    const overdue = isOverdue(item.deadline) && !item.done;
    const repeatText = item.repeat ? '[æ¯æ—¥] ' : '';
    const startText = item.startDate ? `å¼€å§‹:${item.startDate} ` : '';
    const timeText = item.time ? `${item.time} ` : '';
    const deadlineText = item.deadline ? `| æˆªæ­¢:${item.deadline.replace('T',' ')}` : '';
    const div = document.createElement('div'); div.className = 'item';
    div.innerHTML = `<div class="item-left"><input type="checkbox" ${item.done ? 'checked' : ''} onchange="toggleStudy(${idx})"><div class="item-text ${item.done?'done':''} ${overdue?'overdue':''}">${repeatText}${startText} | ${timeText}${item.content}${deadlineText}${overdue?' âš ï¸é€¾æœŸ':''}</div></div><div class="item-del" onclick="delStudy(${idx})">åˆ é™¤</div>`;
    container.appendChild(div);
  });
  calculateStudyTime();
}
function toggleStudy(idx) { let l=storage.get(STORAGE_KEYS.STUDY); l[idx].done=!l[idx].done; storage.set(STORAGE_KEYS.STUDY,l); renderStudy(); if(document.getElementById('calendar').classList.contains('show')) renderCalendar(state.currentCalYear, state.currentCalMonth); }
function delStudy(idx) { let l=storage.get(STORAGE_KEYS.STUDY); l.splice(idx,1); storage.set(STORAGE_KEYS.STUDY,l); renderStudy(); if(document.getElementById('calendar').classList.contains('show')) renderCalendar(state.currentCalYear, state.currentCalMonth); }

// ================== è¿åŠ¨æ‰“å¡ ==================
function addSport() {
  const type = document.getElementById('sportType').value;
  const num = document.getElementById('sportNum').value;
  const date = document.getElementById('sportDate').value || storage.getToday();
  const repeat = document.getElementById('sportRepeat').checked;
  if (!num) return alert('è¯·è¾“å…¥æ¬¡æ•°/åˆ†é’Ÿ');
  const list = storage.get(STORAGE_KEYS.SPORT);
  list.push({ date, type, num, repeat });
  storage.set(STORAGE_KEYS.SPORT, list);
  document.getElementById('sportNum').value = '';
  document.getElementById('sportRepeat').checked = false;
  renderSport();
  if (document.getElementById('calendar').classList.contains('show')) renderCalendar(state.currentCalYear, state.currentCalMonth);
}
function renderSport() {
  const list = storage.get(STORAGE_KEYS.SPORT);
  const container = document.getElementById('sportList');
  container.innerHTML = '';
  list.forEach((item, idx) => {
    const repeatText = item.repeat ? '[æ¯æ—¥] ' : '';
    const div = document.createElement('div'); div.className = 'item';
    div.innerHTML = `<div class="item-left">${repeatText}${item.date}ï½œ${item.type} Ã— ${item.num}</div><div class="item-del" onclick="delSport(${idx})">åˆ é™¤</div>`;
    container.appendChild(div);
  });
}
function delSport(idx) { let l=storage.get(STORAGE_KEYS.SPORT); l.splice(idx,1); storage.set(STORAGE_KEYS.SPORT,l); renderSport(); if(document.getElementById('calendar').classList.contains('show')) renderCalendar(state.currentCalYear, state.currentCalMonth); }

// ================== å¤ä¹ è®¡åˆ’ ==================
function createMultiEbb() {
  const subject = document.getElementById('ebbSubject').value.trim();
  const startDate = document.getElementById('ebbDate').value;
  if (!subject || !startDate) return alert('è¯·å¡«å†™ç§‘ç›®ä¸æ—¥æœŸ');
  const intervals = [0,1,3,6,14,29];
  const list = storage.get(STORAGE_KEYS.MEBB);
  intervals.forEach(offset => {
    const d = new Date(startDate); d.setDate(d.getDate()+offset);
    list.push({ type:'ebb', subject, date: d.toISOString().split('T')[0] });
  });
  storage.set(STORAGE_KEYS.MEBB, list);
  renderMultiEbb();
  if (document.getElementById('calendar').classList.contains('show')) renderCalendar(state.currentCalYear, state.currentCalMonth);
}
function renderMultiEbb() {
  const list = storage.get(STORAGE_KEYS.MEBB);
  const container = document.getElementById('ebbBox');
  container.innerHTML = '<h4>å¤ä¹ è®¡åˆ’åˆ—è¡¨</h4>';
  const grouped = {};
  list.forEach((item, idx) => {
    if (!grouped[item.subject]) grouped[item.subject] = { list: [], idxs: [] };
    grouped[item.subject].list.push(item.date);
    grouped[item.subject].idxs.push(idx);
  });
  for (let sub in grouped) {
    grouped[sub].list.sort();
    const card = document.createElement('div'); card.className = 'card';
    let html = `<div class="flex"><strong>${sub}</strong><div class="ebb-btn-group"><button class="ebb-btn" onclick="extendEbb30Days('${sub}')">+å»¶é•¿30å¤©</button></div></div>`;
    grouped[sub].list.forEach((date, i) => {
      const idx = grouped[sub].idxs[i];
      html += `<div class="item"><div class="item-left">${date}</div><div class="ebb-btn-group"><button class="ebb-btn ebb-del-btn" onclick="delEbb(${idx})">åˆ é™¤</button></div></div>`;
    });
    card.innerHTML = html;
    container.appendChild(card);
  }
}
function extendEbb30Days(subject) {
  const list = storage.get(STORAGE_KEYS.MEBB);
  const subItems = list.filter(i=>i.subject===subject).sort((a,b)=>new Date(a.date)-new Date(b.date));
  if (!subItems.length) return alert('æ— è®¡åˆ’');
  const last = new Date(subItems[subItems.length-1].date);
  last.setDate(last.getDate()+30);
  list.push({ type:'ebb', subject, date: last.toISOString().split('T')[0] });
  storage.set(STORAGE_KEYS.MEBB, list);
  renderMultiEbb();
  if (document.getElementById('calendar').classList.contains('show')) renderCalendar(state.currentCalYear, state.currentCalMonth);
}
function delEbb(idx) { let l=storage.get(STORAGE_KEYS.MEBB); l.splice(idx,1); storage.set(STORAGE_KEYS.MEBB,l); renderMultiEbb(); if(document.getElementById('calendar').classList.contains('show')) renderCalendar(state.currentCalYear, state.currentCalMonth); }

// ================== æ—¥å†æ ¸å¿ƒï¼ˆç”Ÿæ´»/å­¦ä¹ å¯æŠ˜å ï¼Œè¿åŠ¨/å¤ä¹ å§‹ç»ˆæ˜¾ç¤ºï¼‰==================
function initCalSelect() {
  const yS = document.getElementById('calYear'), mS = document.getElementById('calMonth');
  const now = new Date(), curY = now.getFullYear();
  yS.innerHTML = ''; mS.innerHTML = '';
  for (let y = curY-5; y <= curY+5; y++) {
    let opt = document.createElement('option'); opt.value = y; opt.textContent = y+'å¹´';
    if (y === state.currentCalYear) opt.selected = true;
    yS.appendChild(opt);
  }
  for (let m = 0; m < 12; m++) {
    let opt = document.createElement('option'); opt.value = m; opt.textContent = (m+1)+'æœˆ';
    if (m === state.currentCalMonth) opt.selected = true;
    mS.appendChild(opt);
  }
}

function renderCalendarBySelect() {
  state.currentCalYear = parseInt(document.getElementById('calYear').value);
  state.currentCalMonth = parseInt(document.getElementById('calMonth').value);
  renderCalendar(state.currentCalYear, state.currentCalMonth);
}
function renderCalendarToday() {
  const n = new Date();
  state.currentCalYear = n.getFullYear(); state.currentCalMonth = n.getMonth();
  initCalSelect();
  renderCalendar(state.currentCalYear, state.currentCalMonth);
}

function toggleDateFold(dateStr, event) {
  if (event) event.stopPropagation();
  state.data.calFold[dateStr] = !state.data.calFold[dateStr];
  localStorage.setItem(STORAGE_KEYS.CAL_FOLD, JSON.stringify(state.data.calFold));
  renderCalendar(state.currentCalYear, state.currentCalMonth);
}

function toggleAllCollapse() {
  const anyCollapsed = Object.values(state.data.calFold).some(v=>v===true);
  const target = !anyCollapsed;
  const year = state.currentCalYear, month = state.currentCalMonth;
  const lastDay = new Date(year, month+1, 0).getDate();
  for (let d=1; d<=lastDay; d++) {
    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    state.data.calFold[dateStr] = target;
  }
  localStorage.setItem(STORAGE_KEYS.CAL_FOLD, JSON.stringify(state.data.calFold));
  document.getElementById('collapseAllBtn').textContent = target ? 'å…¨éƒ¨å±•å¼€' : 'å…¨éƒ¨æ”¶èµ·';
  renderCalendar(year, month);
}

function toggleCalDone(key) {
  state.data.calDone[key] = !state.data.calDone[key];
  storage.set(STORAGE_KEYS.CAL_DONE, state.data.calDone);
  renderCalendar(state.currentCalYear, state.currentCalMonth);
}

// åˆ¤æ–­æ—¥æœŸæ˜¯å¦åœ¨ä»»åŠ¡çš„æœ‰æ•ˆæœŸå†…ï¼ˆå¼€å§‹æ—¥æœŸ <= å½“å‰æ—¥æœŸ <= æˆªæ­¢æ—¥æœŸï¼‰
function isWithinRange(dateStr, startDate, deadline) {
  const current = new Date(dateStr);
  const start = new Date(startDate);
  current.setHours(0,0,0,0);
  start.setHours(0,0,0,0);
  if (current < start) return false;
  if (deadline) {
    const end = new Date(deadline);
    end.setHours(23,59,59,999);
    if (current > end) return false;
  }
  return true;
}

function renderCalendar(year, month) {
  const calendarBox = document.getElementById('calendarBox');
  calendarBox.innerHTML = '';
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month+1, 0);
  const firstDayWeek = firstDay.getDay() || 7;
  const daysInMonth = lastDay.getDate();

  const lifeList = storage.get(STORAGE_KEYS.LIFE);
  const studyList = storage.get(STORAGE_KEYS.STUDY);
  const sportList = storage.get(STORAGE_KEYS.SPORT);
  const ebbList = storage.get(STORAGE_KEYS.MEBB);

  for (let i=1; i<firstDayWeek; i++) {
    calendarBox.appendChild(document.createElement('div')).className = 'cal-day';
  }

  for (let day=1; day<=daysInMonth; day++) {
    const currentDate = new Date(year, month, day);
    const dateStr = storage.formatDate(currentDate);
    const dayDiv = document.createElement('div');
    dayDiv.className = 'cal-day';
    if (state.data.calFold[dateStr]) dayDiv.classList.add('collapsed');

    const streakStudy = calculateCurrentStreak('study');
    const streakSport = calculateCurrentStreak('sport');
    const foldIndicator = state.data.calFold[dateStr] ? 'ğŸ”½' : 'ğŸ”¼';
    
    dayDiv.innerHTML = `
      <div class="cal-title" onclick="toggleDateFold('${dateStr}', event)">
        ${month+1}æœˆ${day}æ—¥
        <span class="cal-toggle-indicator">${foldIndicator}</span>
        ${dateStr === storage.getToday() ? `<span class="cal-streak">å­¦${streakStudy} | è¿${streakSport}</span>` : ''}
      </div>
    `;

    // ç”Ÿæ´»å¾…åŠï¼ˆå¯æŠ˜å ï¼šæ·»åŠ ç±» foldableï¼‰
    lifeList.forEach((item, idx) => {
      if (item.repeat || isWithinRange(dateStr, item.startDate, item.deadline)) {
        const key = `life_${idx}_${dateStr}`;
        const isDone = state.data.calDone[key] || item.done;
        const itemDiv = document.createElement('div');
        itemDiv.className = 'cal-item foldable';
        itemDiv.innerHTML = `<input type="checkbox" ${isDone ? 'checked' : ''} onchange="toggleCalDone('${key}')"><span class="${isDone ? 'done' : (isOverdue(item.deadline) && !item.done ? 'overdue' : '')}">[ç”Ÿæ´»] ${item.text}</span>`;
        dayDiv.appendChild(itemDiv);
      }
    });

    // å­¦ä¹ æ—¥ç¨‹ï¼ˆå¯æŠ˜å ï¼‰
    studyList.forEach((item, idx) => {
      if (item.repeat || isWithinRange(dateStr, item.startDate, item.deadline)) {
        const key = `study_${idx}_${dateStr}`;
        const isDone = state.data.calDone[key] || item.done;
        const itemDiv = document.createElement('div');
        itemDiv.className = 'cal-item foldable';
        itemDiv.innerHTML = `<input type="checkbox" ${isDone ? 'checked' : ''} onchange="toggleCalDone('${key}')"><span class="${isDone ? 'done' : (isOverdue(item.deadline) && !item.done ? 'overdue' : '')}">[å­¦ä¹ ] ${item.content} ${item.time ? `(${item.time})` : ''}</span>`;
        dayDiv.appendChild(itemDiv);
      }
    });

    // è¿åŠ¨æ‰“å¡ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼šæ·»åŠ ç±» always-showï¼‰
    sportList.forEach((item, idx) => {
      if (item.repeat || item.date === dateStr) {
        const key = `sport_${idx}_${dateStr}`;
        const isDone = state.data.calDone[key];
        const itemDiv = document.createElement('div');
        itemDiv.className = 'cal-item always-show';
        itemDiv.innerHTML = `<input type="checkbox" ${isDone ? 'checked' : ''} onchange="toggleCalDone('${key}')"><span class="${isDone ? 'done' : ''}">[è¿åŠ¨] ${item.type} Ã— ${item.num}</span>`;
        dayDiv.appendChild(itemDiv);
      }
    });

    // å¤ä¹ è®¡åˆ’ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰
    ebbList.forEach((item, idx) => {
      if (item.date === dateStr) {
        const key = `ebb_${idx}_${dateStr}`;
        const isDone = state.data.calDone[key];
        const itemDiv = document.createElement('div');
        itemDiv.className = 'cal-item always-show';
        itemDiv.innerHTML = `<input type="checkbox" ${isDone ? 'checked' : ''} onchange="toggleCalDone('${key}')"><span class="${isDone ? 'done' : ''}">[å¤ä¹ ] ${item.subject}</span>`;
        dayDiv.appendChild(itemDiv);
      }
    });

    calendarBox.appendChild(dayDiv);
  }

  const anyCollapsed = Object.values(state.data.calFold).some(v=>v===true);
  document.getElementById('collapseAllBtn').textContent = anyCollapsed ? 'å…¨éƒ¨å±•å¼€' : 'å…¨éƒ¨æ”¶èµ·';
}

// ================== å…¶ä»–å·¥å…·å‡½æ•° ==================
function calculateStudyTime() {
  const today = storage.getToday();
  const todaySec = state.data.studyTime.filter(i=>i.date===today).reduce((s,i)=>s+i.seconds,0);
  const weekSec = state.data.studyTime.filter(i=>new Date(i.date) >= new Date(new Date().setDate(new Date().getDate()-new Date().getDay()))).reduce((s,i)=>s+i.seconds,0);
  const totalSec = state.data.studyTime.reduce((s,i)=>s+i.seconds,0);
  document.getElementById('todayStudyTime').textContent = storage.formatTime(todaySec);
  document.getElementById('weekStudyTime').textContent = storage.formatTime(weekSec);
  document.getElementById('totalStudyTime').textContent = storage.formatTime(totalSec);
}
function checkBadge() {
  const box = document.getElementById('badgeBox');
  const total = state.data.points.reduce((s,i)=>s+i.points,0);
  const doneLife = storage.get(STORAGE_KEYS.LIFE).filter(i=>i.done).length;
  const doneStudy = storage.get(STORAGE_KEYS.STUDY).filter(i=>i.done).length;
  const maxStudy = state.data.streak.maxStudy || 0;
  const maxSport = state.data.streak.maxSport || 0;
  const badges = [
    { name:'ç§¯åˆ†100åˆ†', cond: total>=100 },
    { name:'å®Œæˆ50ä¸ªä»»åŠ¡', cond: doneLife+doneStudy >= 50 },
    { name:'è¿ç»­å­¦ä¹ 7å¤©', cond: maxStudy>=7 },
    { name:'è¿ç»­è¿åŠ¨7å¤©', cond: maxSport>=7 },
    { name:'è¿ç»­å­¦ä¹ 30å¤©', cond: maxStudy>=30 },
    { name:'è¿ç»­è¿åŠ¨30å¤©', cond: maxSport>=30 },
  ];
  box.innerHTML = '';
  badges.forEach(b => {
    const d = document.createElement('div');
    d.className = `badge ${b.cond ? '' : 'locked'}`;
    d.textContent = b.name;
    box.appendChild(d);
  });
}
function resetTomato() {
  const s = state.data.settings;
  state.tomato = { interval:null, seconds: s.tomatoStudy*60, running:false, isStudy:true, currentCycle:0, totalCycle: parseInt(document.getElementById('tomatoCycle')?.value) || 1 };
  document.getElementById('tomatoDisplay') && (document.getElementById('tomatoDisplay').textContent = `${s.tomatoStudy}:00`);
  document.getElementById('tomatoStatus') && (document.getElementById('tomatoStatus').textContent = 'å‡†å¤‡ä¸­ï¼šå­¦ä¹ æ¨¡å¼');
}
function startTimer() { if(state.timer.running) return; state.timer.running=true; state.timer.interval=setInterval(()=>{ state.timer.seconds++; document.getElementById('timerDisplay').textContent=storage.formatTime(state.timer.seconds); },1000); }
function pauseTimer() { clearInterval(state.timer.interval); state.timer.running=false; }
function resetTimer() { pauseTimer(); state.timer.seconds=0; document.getElementById('timerDisplay').textContent='00:00:00'; }
function saveTimerRecord() {
  if(state.timer.seconds===0) return alert('æ— è®°å½•');
  const task = document.getElementById('timerTask').value.trim() || 'æœªå‘½å';
  state.data.studyTime.push({ date:storage.getToday(), task, seconds:state.timer.seconds, time:new Date().toLocaleString() });
  storage.set(STORAGE_KEYS.STUDY_TIME, state.data.studyTime);
  addPoints('å­¦ä¹ è®¡æ—¶', Math.floor(state.timer.seconds/3600)*20);
  resetTimer(); calculateStudyTime(); alert('å·²ä¿å­˜');
}
function startTomato() { /* ç®€åŒ–ç‰ˆ */ alert('ç•ªèŒ„é’Ÿæ¼”ç¤º'); }
function pauseTomato() {}
function generateShareImage() {}
function copyShareImage() {}
function saveShareImage() {}
function backupData() { alert('å¤‡ä»½æ¼”ç¤º'); }
function restoreData() { alert('æ¢å¤æ¼”ç¤º'); }
function exportExcel() { alert('å¯¼å‡ºæ¼”ç¤º'); }
function clearAll() { if(confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿ')) { Object.values(STORAGE_KEYS).forEach(k=>localStorage.removeItem(k)); location.reload(); } }

window.onload = initApp;
</script>
</body>
</html>